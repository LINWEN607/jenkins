pipeline {
    agent {
        node {
            label "master"
        }
    }

    tools {
        go 'go1.23'
    }

    environment {
        PATH = "${env.GOPATH}:${env.PATH}"
        // PROJECT_NAME 不能在这里用 sh 动态赋值
    }

    stages {
        stage('1.拉取代码') {
            steps {
                script {
                    def git_address = "http://10.255.5.150/cloud-platform/hbe-charge.git"
                    def git_auth = "git-root"
                    def git_branch = env.BRANCH_NAME

                    git(
                        branch: git_branch, 
                        credentialsId: git_auth, 
                        url: git_address
                    )

                    // 在这里动态赋值 PROJECT_NAME
                    env.PROJECT_NAME = sh(
                        script: """
                            echo ${env.GIT_URL} | awk -F'/' '{print \$NF}' | sed 's/\\..*//'
                        """,
                        returnStdout: true
                    ).trim()
                }
            }
        }

        stage('2.判断修改模块') {
            steps {
                script {
                    // 获取所有文件的修改时间和文件名，找出最新的
                    def latestFileInfo = sh(
                        script: 'git ls-files -z | xargs -0 stat -c "%Y %n" | sort -nr | head -n 1',
                        returnStdout: true
                    ).trim()
                    def latestFile = latestFileInfo.split(' ', 2)[1]

                    def app = null
                    if (latestFile.startsWith('app/backend/')) {
                        app = 'backend'
                    } else if (latestFile.startsWith('app/csms1.6/')) {
                        app = 'csms1.6'
                    } else if (latestFile.startsWith('app/frontend/')) {
                        app = 'frontend'
                    } else if (latestFile.startsWith('app/jobs/')) {
                        app = 'jobs'
                    }

                    if (app == null) {
                        error("未检测到任何模块被修改，请检查提交内容。")
                    } else {
                        env.APP_TO_BUILD = app
                        echo "本次只构建最新修改文件所属模块: ${app}，文件为: ${latestFile}"
                    }
                }
            }
        }

        stage('3.编译程序') {
            steps {
                script {
                    def app = env.APP_TO_BUILD

                    // 进入对应子模块目录并构建
                    sh """
                        echo '开始构建模块: ${app}'
                        cd app/${app}
                        export GOPROXY=https://goproxy.cn,direct
                        go build -o main main.go
                        # 将模块的二进制文件保存到独立目录
                        mkdir -p /var/jenkins_home/${app}
                        cp main /var/jenkins_home/${app}/
                    """
                }
            }
        }

        stage('4.部署程序') {
            steps {
                script {
                    def deployConfig = [
                        release: [host: "120.77.170.190", sshCredentialId: "dev-ssh-key", port: "1022"],
                        main: [host: "192.168.0.210", sshCredentialId: "main-ssh-key"],
                        prod: [host: "192.168.1.30", sshCredentialId: "prod-ssh-key"]
                    ]

                    def targetBranch = env.BRANCH_NAME
                    def config = deployConfig[targetBranch]

                    if (!config) {
                        error("未配置该分支的部署信息: ${targetBranch}")
                    }

                    def app = env.APP_TO_BUILD
                    def remotePath = "/usr/local/www/go/src/hbe-charge/app/${app}"

                    sshagent([config.sshCredentialId]) {
                        // 备份旧版本文件
                        sh """
                            ssh -p ${config.port} -o StrictHostKeyChecking=no root@${config.host} '
                                BASE_NAME="hbe-charge"
                                DEPLOY_PATH="${remotePath}"
                                FILE_PATH="\$DEPLOY_PATH/main"
                                echo "备份旧版本文件..."
                                if [ -f "\$FILE_PATH" ]; then
                                    mkdir -p /data/backup/hbe-charge/${app}
                                    TIMESTAMP=\$(date +%Y%m%d%H%M%S)
                                    BACKUP_FILE="/data/backup/hbe-charge/${app}/\$BASE_NAME-\$TIMESTAMP"
                                    cp "\$FILE_PATH" "\$BACKUP_FILE"
                                    echo "已备份旧文件到: \$BACKUP_FILE"
                                    ls -t /data/backup/hbe-charge/${app}/\$BASE_NAME-* 2>/dev/null | tail -n +4 | xargs -r rm -f
                                    echo "已清理多余备份文件"
                                else
                                    echo "未找到旧版本文件"
                                fi
                            '
                        """

                        // 部署新程序并重启服务
                        sh """
                            echo '开始部署模块: ${app}...'
                            # 先停止服务
                            ssh -o StrictHostKeyChecking=no root@${config.host} "
                                echo '停止旧服务...'
                                systemctl stop hbecharge_${app}
                            "
                            
                            # 再复制文件
                            scp /var/jenkins_home/${app}/main root@${config.host}:${remotePath}/
                            
                            # 最后启动服务
                            ssh -o StrictHostKeyChecking=no root@${config.host} "
                                echo '启动新程序...'
                                # 启动服务
                                systemctl start hbecharge_${app}
                            "
                        """
                    }
                }
            }
        }
    }


    post {
        success {
            script {
                def buildUser = currentBuild.getBuildCauses()[0].userId ?: 'System'
                dingtalk (
                    robot: 'cicd构建推送',
                    type: 'MARKDOWN',
                    title: '构建成功通知',
                    text: [
                        """###  构建成功
                    
- **项目名称**：${env.PROJECT_NAME}
- **任务名称**：${env.JOB_NAME}
- **构建服务**：${env.APP_TO_BUILD}
- **任务状态**：构建成功
- **任务持续时间**：${currentBuild.durationString}
- **Commit ID**：${shortCommit}
- **Commit 信息**：${commitMessage}
- **修改人**：${commitAuthor}

> 构建时间：${new Date().format("yyyy-MM-dd HH:mm:ss")}
> 构建人：${buildUser}

**操作建议**：
- 可到对应项目分支的环境测试验证功能。（/data/backup/hbe-charge/服务名称）此路径备份此前三个版本的编译文件，可按时间戳区分"""
                    ]
                )
            }
        }
        
        failure {
            script {
                def buildUser = currentBuild.getBuildCauses()[0].userId ?: 'System'
                dingtalk (
                    robot: 'cicd构建推送',
                    type: 'MARKDOWN',
                    title: '构建失败通知',
                    text: [
                        """###  构建失败
                    
- **项目名称**：${env.PROJECT_NAME}
- **任务名称**：${env.JOB_NAME}
- **构建服务**：${env.APP_TO_BUILD}
- **任务状态**：构建失败
- **任务持续时间**：${currentBuild.durationString}
- **Commit ID**：${shortCommit}
- **Commit 信息**：${commitMessage}
- **修改人**：${commitAuthor}

> 构建时间：${new Date().format("yyyy-MM-dd HH:mm:ss")}
> 构建人：${buildUser}

**操作建议**：
- 联系林文进行排查"""
                    ]
                )
            }
        }

        unstable {
            script {
                def buildUser = currentBuild.getBuildCauses()[0].userId ?: 'System'
                dingtalk (
                    robot: 'cicd构建推送',
                    type: 'MARKDOWN',
                    title: '构建不稳定通知',
                    text: [
                        """###  构建不稳定
                    
- **项目名称**：${env.PROJECT_NAME}
- **任务名称**：${env.JOB_NAME}
- **构建服务**：${env.APP_TO_BUILD}
- **任务状态**：构建不稳定
- **任务持续时间**：${currentBuild.durationString}
- **Commit ID**：${shortCommit}
- **Commit 信息**：${commitMessage}
- **修改人**：${commitAuthor}

> 构建时间：${new Date().format("yyyy-MM-dd HH:mm:ss")}
> 构建人：${buildUser}

**操作建议**：
- 请联系林文进行排查"""
                    ]
                )
            }
        }

        aborted {
            script {
                def buildUser = currentBuild.getBuildCauses()[0].userId ?: 'System'
                dingtalk (
                    robot: 'cicd构建推送',
                    type: 'MARKDOWN',
                    title: '构建中止通知',
                    text: [
                        """###  构建被中止
                    
- **项目名称**：${env.PROJECT_NAME}
- **任务名称**：${env.JOB_NAME}
- **构建服务**：${env.APP_TO_BUILD}
- **任务状态**：构建中止
- **任务持续时间**：${currentBuild.durationString}
- **Commit ID**：${shortCommit}
- **Commit 信息**：${commitMessage}
- **修改人**：${commitAuthor}

> 构建时间：${new Date().format("yyyy-MM-dd HH:mm:ss")}
> 构建人：${buildUser}

**操作建议**：
- 请确认是否是人为中止或交互式中止（生产环境上线前期部署阶段需交互式确认）"""
                    ]
                )
            }
        }
    }
}