pipeline {
    agent {
        node {
            label "master"
        }
    }

    tools {
        go 'go1.23.0'
    }

    environment {
        PATH = "${env.GOPATH}:${env.PATH}"
        PROJECT_NAME = sh(script: """
            echo ${env.GIT_URL} | awk -F'/' '{print $NF}' | sed 's/\\..*//'
        """, returnStdout: true).trim()
    }

    stages {
        stage('1.拉取代码') {
            steps {
                script {
                    def git_address = "http://192.168.30.111/lins/hbe-charge.git"
                    def git_auth = "git-root"
                    def git_branch = env.BRANCH_NAME
                    
                    git(
                        branch: git_branch, 
                        credentialsId: git_auth, 
                        url: git_address
                    )
                }
            }
        }

        stage('2.编译程序') {
            steps {
                sh """
                    #!/bin/bash
                    cd ${env.WORKSPACE}
                    export GOPROXY=https://goproxy.cn,direct
                    go build -o ${env.PROJECT_NAME} main.go
                    cp ${env.PROJECT_NAME} /var/jenkins_home/${env.PROJECT_NAME}
                """
            }
        }

        stage('3.部署程序') {
            steps {
                script {
                    def deployConfig = [
                        release: [host: "192.168.30.111", path: "/usr/local/www/go/hbe-charge/app/backend", sshCredentialId: "test-ssh-key"],
                        main: [host: "192.168.0.210", path: "/home/main/teset-server", sshCredentialId: "main-ssh-key"],
                        prod: [host: "192.168.1.30", path: "/home/prod/training-ip-demo", sshCredentialId: "prod-ssh-key"]
                    ]

                    def targetBranch = env.BRANCH_NAME
                    def config = deployConfig[targetBranch]

                    if (!config) {
                        error("未配置该分支的部署信息: ${targetBranch}")
                    }

                    sshagent([config.sshCredentialId]) {
                        // 杀死旧进程
                        sh """
                            ssh -o StrictHostKeyChecking=no root@${config.host} "
                                echo '开始查找并终止旧进程...'
                                OLD_PID=\$(ps -ef | grep ${env.PROJECT_NAME} | grep -v grep | grep -v jenkins | awk '{print \$2}')
                                if [ -n \"\$OLD_PID\" ]; then
                                    echo \"找到旧进程 ID: \$OLD_PID，正在终止...\"
                                    sudo kill -9 \$OLD_PID || echo \"终止旧进程失败\"
                                else
                                    echo '未找到旧进程'
                                fi
                            "
                        """

                        // 备份旧版本文件（添加时间后缀，保留最多 3 个）
                        sh """
                            ssh -o StrictHostKeyCheck=no root@${config.host} "
                                echo '备份旧版本文件...'
                                BASE_NAME=${env.PROJECT_NAME}
                                DEPLOY_PATH=${config.path}
                                BACKUP_DIR=/data/backup/\${BASE_NAME}
                                FILE_PATH=\${DEPLOY_PATH}/\${BASE_NAME}

                                # 如果文件存在，则备份
                                if [ -f \"\$FILE_PATH\" ]; then
                                    # 创建备份目录
                                    mkdir -p \$BACKUP_DIR

                                    # 添加时间后缀并移动到备份目录
                                    TIMESTAMP=\$(date +%Y%m%d%H%M%S)
                                    BACKUP_FILE=\${BACKUP_DIR}/\${BASE_NAME}-\${TIMESTAMP}
                                    mv \"\$FILE_PATH\" \"\$BACKUP_FILE\"
                                    echo '已备份旧文件到: \$BACKUP_FILE'

                                    # 保留最多 3 个备份
                                    BACKUP_FILES=(\$(ls -t \${BACKUP_DIR}/\${BASE_NAME}-* 2>/dev/null))
                                    while [ \$#BACKUP_FILES -gt 3 ]; do
                                        OLDEST=\${BACKUP_FILES[-1]}
                                        echo '删除旧备份: \$OLDEST'
                                        rm -f \"\$OLDEST\"
                                        unset BACKUP_FILES[-1]
                                        BACKUP_FILES=(\${BACKUP_FILES[@]})
                                    done
                                else
                                    echo '未找到旧版本文件'
                                fi
                            "
                        """

                        // 部署新程序
                        sh """
                            echo '开始部署新程序...'
                            scp /var/jenkins_home/${env.PROJECT_NAME} root@${config.host}:${config.path}/
                            ssh -o StrictHostKeyCheck=no root@${config.host} "
                                echo '创建部署目录...'
                                mkdir -p ${config.path}
                                echo '启动新程序...'
                                cd ${config.path} && 
                                JENKINS_NODE_COOKIE=dontKillMe nohup ./${env.PROJECT_NAME} > /dev/null 2>&1 &
                            "
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            dingTalk (
                robot: 'dev-robot',  // 引用系统配置的机器人 ID
                message: """
{
    "msgtype": "markdown",
    "markdown": {
        "title": "构建成功",
        "text": "### 🎉 构建成功\n\n" +
                "项目名称: `\${env.PROJECT_NAME}`\n" +
                "分支: `${env.BRANCH_NAME}`\n" +
                "构建结果: 成功 ✅\n" +
                "构建链接: [点击查看](${env.BUILD_URL})\n\n" +
                "> 自动部署完成，请检查目标服务器状态。"
    }
}
                """
            )
        }

        failure {
            dingTalk (
                robot: 'dev-robot',
                message: """
{
    "msgtype": "markdown",
    "markdown": {
        "title": "构建失败",
        "text": "### ❌ 构建失败\n\n" +
                "项目名称: `\${env.PROJECT_NAME}`\n" +
                "分支: `${env.BRANCH_NAME}`\n" +
                "构建结果: 失败 ❌\n" +
                "构建链接: [点击查看](${env.BUILD_URL})\n\n" +
                "> 请检查 Jenkins 日志以获取详细错误信息。"
    }
}
                """
            )
        }
    }
}